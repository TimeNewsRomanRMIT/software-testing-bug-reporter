<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bug Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .section-title { margin-top:2rem; font-size:1.25rem; color:#333; }
    .board { margin-top:1rem; }
    .board .card { margin-bottom:0.75rem; padding:0.75rem; }
    .board .card p { margin:0.3rem 0; font-size:0.95rem; }
  </style>
</head>
<body>
  <div class="container">
    <header class="hero-banner">
      <div class="logo-container">
        <img src="rmit-logo.png" alt="School Logo" class="logo">
      </div>
    </header>

    <div class="card header-card">
      <h1>Bug Dashboard</h1>
    </div>

    <!-- Team Leaderboard -->
    <h2 class="section-title">Team Leaderboard</h2>
    <div id="team-board" class="board">
      <p>Loading team leaderboard…</p>
    </div>

    <!-- Unique Bugs -->
    <h2 class="section-title">Unique Bugs</h2>
    <div id="unique-board" class="board">
      <p>Loading unique bugs…</p>
    </div>

    <div class="buttons">
      <a href="index.html" class="button">← Report Bugs</a>
      <a href="submissions.html" class="button">View All Submissions →</a>
    </div>
  </div>

  <script>
    let groupsData = [];

    async function loadAll() {
      const res    = await fetch('/api/bugs/groups');
      groupsData   = await res.json();
      // Annotate each group with its 1-based index
      groupsData.forEach((g,i) => g.index = i+1);

      renderTeamBoard();
      renderUniqueBoard();
    }

    function renderTeamBoard() {
      const el = document.getElementById('team-board');
      el.innerHTML = '';
      if (!groupsData.length) {
        el.textContent = 'No data yet—submit some bugs!';
        return;
      }
      // Build map: team → [bugIndices]
      const map = {};
      groupsData.forEach(g => {
        g.teams.forEach(team => {
          ;(map[team] ||= []).push(g.index);
        });
      });
      // Sort teams by number of unique bugs desc
      const sorted = Object.keys(map).sort((a,b) =>
        map[b].length - map[a].length || a.localeCompare(b)
      );
      sorted.forEach((team, rank) => {
        const bugs = map[team];           // e.g. [1,2,5]
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <p><strong>${rank+1}. ${team}</strong></p>
          <p>
            ${bugs.length} URL${bugs.length>1?'s':''} — 
            ${bugs.length} bug${bugs.length>1?'s':''} 
            (bug ${bugs.join(', bug ')})
          </p>
        `;
        el.appendChild(card);
      });
    }

    function renderUniqueBoard() {
      const el = document.getElementById('unique-board');
      el.innerHTML = '';
      if (!groupsData.length) {
        el.textContent = 'No bugs reported yet.';
        return;
      }
      groupsData.forEach(g => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <p><strong>${g.index}. Bug ${g.index}</strong></p>
          <p>${g.teams.length} team${g.teams.length>1?'s':''} reported this</p>
          <details>
            <summary>View teams</summary>
            <ul>
              ${g.teams.map(t=>`<li>${t}</li>`).join('')}
            </ul>
          </details>
        `;
        el.appendChild(card);
      });
    }

    document.addEventListener('DOMContentLoaded', loadAll);
  </script>
</body>
</html>
